<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamHub - íŒ€ ëŒ€ê¸°</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='waiting_for_teample.css') }}" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="profile"> 
                <div class="profile-pic"></div>
                <h3>{{session['username']}}</h3>
                <p>í•™ë²ˆ: {{session['student_number']}}</p>
                <p>ì „ê³µ: {{session['major']}}</p> 
                <p>í•™ë…„: {{ session['grade']}}í•™ë…„</p> 
            </div>
            
            <div class="notice"> 
                <h4>ì•Œë¦¼</h4>
                <p>êµìˆ˜ë‹˜ì´ íŒ€ì„ êµ¬ì„± ì¤‘ì…ë‹ˆë‹¤</p>
                <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                <p>íŒ€ì´ ìƒì„±ë˜ë©´ ìë™ìœ¼ë¡œ ì•ˆë‚´ë©ë‹ˆë‹¤</p>
            </div>
        </div>

        <div class="main-content">
            <!-- ëŒ€ê¸° ë©”ì‹œì§€ -->
            <div id="message">
                <h1>êµìˆ˜ë‹˜ì´ íŒ€ì„ êµ¬ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤</h1>
                <p>íŒ€ êµ¬ì„±ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.<br>
                   íŒ€ì´ ìƒì„±ë˜ë©´ ìë™ìœ¼ë¡œ íŒ€ ì„ íƒ í™”ë©´ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.</p>
                
                <div class="loading-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <!-- íŒ€ ì„ íƒ ì˜ì—­ (ì²˜ìŒì—ëŠ” ìˆ¨ê¹€) -->
            <div id="choose_team" style="display: none;">
                <div class="team-selection-header">
                    <h2>íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</h2>
                    <p>ì›í•˜ëŠ” íŒ€ì„ ì„ íƒí•´ì„œ ì°¸ì—¬í•˜ì„¸ìš”</p>
                </div>

                <div class="team-grid">
                    {% for team in team_info %}
                    <div class="team-card">
                        <div class="team-header">
                            <h3>{{ team.team_name if team.team_name else 'íŒ€ ' + team.team_id|string }}</h3>
                            <span class="team-capacity available">
                                {{ team.current_members|default(0) }}/{{ team.team_size if team.team_size else '4' }}
                            </span>
                        </div>
                        
                        <div class="team-members">
                            <h4>í˜„ì¬ íŒ€ì›</h4>
                            {% if team_relationship and team_relationship.get('username') %}
                                <div class="members-list">
                                    {% for member in team_relationship['username'] %}
                                        {% if member['team_id'] == team['team_id'] %}
                                            <span class="member-tag">{{ member['username'] }}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="empty-slots">ì•„ì§ ì°¸ì—¬í•œ íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            {% endif %}
                        </div>

                        <form action="/join_team" method="POST" onsubmit="join_team_socket('{{ team.team_id if team.team_id else team[2] }}')"> 
                            <input type="hidden" id="team_id_{{ team.team_id if team.team_id else team[2] }}" 
                                   name="team_id" value="{{ team.team_id if team.team_id else team[2] }}">   
                            <button id="team_button" type="submit">ì´ íŒ€ ì„ íƒí•˜ê¸°</button>
                        </form>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- í”Œë˜ì‹œ ë©”ì‹œì§€ -->
    {% with messages = get_flashed_messages() %}
        {% if messages %}     
        <script>
            const message = "{{ messages[-1] }}";
            const isError = message.includes('ì˜¤ë¥˜') || message.includes('ì‹¤íŒ¨');
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${isError ? '#ef4444' : '#10b981'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px ${isError ? 'rgba(239, 68, 68, 0.3)' : 'rgba(16, 185, 129, 0.3)'};
                z-index: 1000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        </script>
        {% endif %}
    {% endwith %}

    <!-- ì†Œì¼“ í†µì‹  -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const socket = io();
        
        socket.on('connect', () => {
            console.log('ğŸŸ¢ ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤:', socket.id);
        });

        // íŒ€ ìƒì„± ë°©ì‹ ìˆ˜ì‹ 
        socket.on('creator_method', function(data) {
            console.log('íŒ€ ìƒì„± ì•Œë¦¼ ìˆ˜ì‹ :', data.msg);
            
            // ëŒ€ê¸° ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            document.getElementById('message').style.display = 'none';
            
            // íŒ€ ì„ íƒ ì˜ì—­ í‘œì‹œ
            document.getElementById('choose_team').style.display = 'block';
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            const successMessage = document.createElement('div');
            successMessage.className = 'status-message success';
            successMessage.innerHTML = `
                <h3>âœ… íŒ€ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
                <p>ì•„ë˜ì—ì„œ ì›í•˜ëŠ” íŒ€ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            `;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(successMessage, document.getElementById('choose_team'));
            
            // 3ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
            setTimeout(() => {
                successMessage.remove();
            }, 3000);
        });
        
        // íŒ€ ì°¸ì—¬ ì†Œì¼“ ì´ë²¤íŠ¸
        function join_team_socket(teamId) {
            const username = "{{ session['username'] }}";
            socket.emit('join_team_socket', { 
                team_id: teamId, 
                username: username 
            });
            console.log('íŒ€ ì°¸ì—¬ ìš”ì²­:', { team_id: teamId, username: username });
        }

        // ì—°ê²° ëŠê¹€ ì²˜ë¦¬
        socket.on('disconnect', () => {
            console.log('ğŸ”´ ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤');
            
            // ì—°ê²° ëŠê¹€ ì•Œë¦¼
            const disconnectMessage = document.createElement('div');
            disconnectMessage.className = 'status-message warning';
            disconnectMessage.innerHTML = `
                <h3>âš ï¸ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤</h3>
                <p>ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</p>
            `;
            
            const mainContent = document.querySelector('.main-content');
            const firstChild = mainContent.firstElementChild;
            mainContent.insertBefore(disconnectMessage, firstChild);
        });

        // íŒ€ ì°¸ì—¬ ì„±ê³µ ì•Œë¦¼
        socket.on('team_join_success', function(data) {
            const successNotification = document.createElement('div');
            successNotification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10b981;
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
                z-index: 1000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            successNotification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span>âœ…</span>
                    <span>íŒ€ ì°¸ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</span>
                </div>
            `;
            document.body.appendChild(successNotification);
            
            setTimeout(() => {
                successNotification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => successNotification.remove(), 300);
            }, 3000);
        });
    </script>

    <style>
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</body>      
</html>